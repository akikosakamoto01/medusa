<table class="table table-condensed table-striped">
  <ul>
    <%= li_if_exist 'measurement category: ', @table.measurement_category.try!(:name) %>
    <li>modified at <%= difference_from_now(@table.updated_at) -%></li>
    <% if @table.bib %>
      <li>bib: <%= link_to_if can?(:read, @table.bib), @table.bib.name,bib_path(@table.bib) %></li>
    <% end %>
  </ul>
  <caption>
    <%= @table.description %>
  </caption>
  <thead>
    <tr>
      <th>measured</th>
      <th>unit</th>
      <% @table.stones.each do |stone| %>
	<th><%= stone.name %></th>
      <% end %>
      <% if @table.with_average %>
	<th>avg(std)</th>
      <% end %>
    </tr>
  </thead>
  <tbody>
    <% if @table.with_place %>
      <tr>
	<th>latitude</th>
	<th></th>
	<% @table.stones.each do |stone| %>
	  <td><%= stone.place.try!(:latitude) || "-" %></td>
	<% end %>
	<% if @table.with_average %>
	  <td>-</td>
	<% end %>
      </tr>
      <tr>
	<th>longitude</th>
	<th></th>
	<% @table.stones.each do |stone| %>
	  <td><%= stone.place.try!(:longitude) || "-" %></td>
	<% end %>
	<% if @table.with_average %>
	  <td>-</td>
	<% end %>
      </tr>
    <% end %>
    <% @table.each(display: :html) do |chemical_species, chemistries| %>
      <tr>
	<th><%== chemical_species.caption(:html) %></th>
	<th><%== chemical_species.unit.try!(:html) %></th>
	<% values = [] %>
	<% @table.stones.each do |stone| %>
	  <% values << chemistries[stone.id].try!(:unit_conversion_value, chemical_species.unit.name) %>
	  <td><%= chemistries[stone.id].try!(:unit_conversion_value, chemical_species.unit.name, chemical_species.scale) || "-" %></td>
	<% end %>
	<% if @table.with_average %>
	  <% values.compact! %>
	  <%# TODO: 標準偏差を求めるには全化学組成の平均値が必要、先に算出しておく必要あり %>
	  <td><%= values.blank? ? "-" : (values.sum / values.size).round(chemical_species.scale) %></td>
	<% end %>
      </tr>
    <% end %>
  </tbody>
</table>
<% @table.method_descriptions.each do |sign, description| %>
  <div class="row">
    <%= "#{sign}: #{description}" %>
  </div>
<% end %>
